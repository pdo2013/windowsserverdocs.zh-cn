---
title: 适用于托管商的受保护的构造和受防护 VM 规划指南
ms.custom: na
ms.prod: windows-server-threshold
ms.topic: article
ms.assetid: 392af37f-a02d-4d40-a25d-384211cbbfdd
manager: dongill
author: nirb-ms
ms.technology: security-guarded-fabric
ms.openlocfilehash: d361dfee0cbb06c4b7908b80145c09327dac3956
ms.sourcegitcommit: f6490192d686f0a1e0c2ebe471f98e30105c0844
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 09/10/2019
ms.locfileid: "70870426"
---
# <a name="guarded-fabric-and-shielded-vm-planning-guide-for-tenants"></a>租户的受保护的构造和受防护 VM 规划指南

>适用于：Windows Server 2019，Windows Server （半年频道），Windows Server 2016

本主题重点介绍要保护其虚拟机（Vm）的 VM 所有者，以确保其符合性和安全性。 无论 Vm 是在托管提供程序的受保护的构造中还是在私有受保护的构造上运行，VM 所有者都需要控制其受防护的 Vm 的安全级别，其中包括保留在需要时对其进行解密的能力。

使用受防护的 Vm 时，需要考虑三个方面：

- Vm 的安全级别
- 用于保护这些密钥的加密密钥
- 屏蔽数据-用于创建受防护 Vm 的敏感信息 

## <a name="security-level-for-the-vms"></a>Vm 的安全级别

部署受防护的 Vm 时，必须选择以下两个安全级别之一：

- 屏蔽 
- 支持加密

受防护和支持加密的 Vm 均附加有虚拟 TPM，并且运行 Windows 的 Vm 受 BitLocker 保护。 主要区别在于受防护的 Vm 会阻止构造管理员的访问，而支持加密的 Vm 则允许结构管理员具有与常规 VM 相同的访问级别。 有关这些差异的详细信息，请参阅[受保护的构造和受防护的 vm 概述](guarded-fabric-and-shielded-vms.md)。 

如果要保护 VM 免受被泄露的结构（包括受攻击的管理员），请选择 "**受防护的 vm** "。 它们应该在构造管理员和结构本身不受信任的环境中使用。 如果希望满足可能要求静态加密和网络加密的符合性要求（例如，在实时迁移期间），请选择 "**支持加密的 vm** "。

支持加密的 Vm 在构造管理员完全受信任但仍要求加密的环境中非常理想。

可以在受保护的构造上，甚至在同一 Hyper-v 主机上运行混合的常规 Vm、受防护的 Vm 和支持加密的 Vm。 

VM 是否受防护或受加密支持由创建 VM 时选择的防护数据决定。 VM 所有者在创建防护数据时配置安全级别（请参阅[防护数据](#shielding-data)部分）。
请注意，一旦做出此选择，在虚拟化结构中保留 VM 时，将无法更改此选项。

## <a name="cryptographic-keys-used-for-shielded-vms"></a>用于受防护的 Vm 的加密密钥

受防护的 Vm 可通过使用加密磁盘的虚拟化结构攻击向量和其他仅可通过解密的加密元素进行保护：

- 所有者密钥–这是由 VM 所有者维护的加密密钥，通常用于上一次滑雪场恢复或故障排除。 VM 所有者负责在安全位置维护所有者密钥。
- 一个或多个监护人（主机保护者密钥）–每个保护者代表一个虚拟化结构，所有者可在该虚拟化结构上授权受防护的 Vm 运行。 企业通常同时具有主和灾难恢复（DR）虚拟化构造，并且通常会授权其受防护的 Vm 在两者上运行。 在某些情况下，辅助（DR）构造可能由公有云提供商托管。 任何受保护的构造的私钥仅在虚拟化结构上维护，而其公钥可下载并包含在其保护者内。 

**如何实现创建所有者密钥？** 所有者密钥由两个证书表示。 用于加密的证书和用于签名的证书。 你可以使用自己的 PKI 基础结构创建这两个证书，或者从公共证书颁发机构（CA）获取 SSL 证书。 出于测试目的，你还可以在任何一台使用 Windows 10 或 Windows Server 2016 的计算机上创建自签名证书。

**应有多少所有者密钥？** 你可以使用一个所有者密钥或多个所有者密钥。 最佳做法为共享相同安全、信任或风险级别以及用于管理控制的一组 Vm 推荐单一所有者密钥。 您可以为所有已加入域的受防护 Vm 共享一个所有者密钥，并将该所有者密钥委托给域管理员管理。

**是否可以将我自己的密钥用于主机保护者？** 是的，你可以将自己的密钥 "自带" 到托管提供商，并将该密钥用于受防护的 Vm。 这样，你就可以使用特定的密钥（与使用托管提供商密钥），并可以在具有需要遵守的特定安全或法规时使用。 出于密钥的试用目的，主机保护者密钥应该与所有者密钥不同。

## <a name="shielding-data"></a>屏蔽数据

屏蔽数据包含部署受防护或支持加密的 Vm 所需的机密。 将常规 Vm 转换为受防护的 Vm 时也使用此方法。

屏蔽数据是使用防护数据文件向导创建的，并存储在 PDK 文件中，VM 所有者将其上传到受保护的结构。

受防护的 Vm 可帮助防止受到受攻击的虚拟化结构的攻击，因此，我们需要一种安全机制来传递敏感的初始化数据，例如管理员密码、域加入凭据或 RDP 证书，而不会将这些数据泄漏到虚拟化构造本身或其管理员。 此外，防护数据包含以下各项：

1. 安全级别–受防护或加密-支持
2. VM 可运行的受信任主机保护者的所有者和列表
3. 虚拟机初始化数据（unattend.xml、RDP 证书）
4. 在虚拟化环境中创建虚拟机的受信任的已签名模板磁盘列表 

创建受防护或支持加密的 VM 或转换现有 VM 时，系统会要求你选择防护数据，而不是提示输入敏感信息。

**我需要多少个防护数据文件？** 单个屏蔽数据文件可用于创建每个受防护的 VM。 但是，如果指定的受防护的 VM 要求四项中的任何一个都不同，则需要额外的屏蔽数据文件。 例如，你的 IT 部门可能有一个防护数据文件，为 HR 部门提供不同的防护数据文件，因为其初始管理员密码和 RDP 证书不同。

虽然可以为每个受防护的 VM 使用单独的防护数据文件，但这并不一定是最佳选择，应该出于正确的原因进行操作。 例如，如果每个受防护的 VM 都需要使用不同的管理员密码，请考虑改用密码管理服务或工具，如[Microsoft 的本地管理员密码解决方案（LAPS）](https://www.microsoft.com/en-us/download/details.aspx?id=46899)。

## <a name="creating-a-shielded-vm-on-a-virtualization-fabric"></a>在虚拟化结构上创建受防护的 VM

有几个选项可用于在虚拟化结构上创建受防护的 VM （以下各项适用于受防护的和支持加密的 Vm）：

1. 在环境中创建受防护的 VM，并将其上传到虚拟化结构
2. 从虚拟化构造上的已签名模板创建新的受防护的 VM
3. 防护现有 VM （现有 VM 必须为第2代，并且必须运行 Windows Server 2012 或更高版本）

通过模板创建新的 Vm 是正常做法。 但是，由于用于创建新的受防护的 VM 的模板磁盘驻留在虚拟化结构上，因此需要额外的措施来确保其未被恶意构造管理员或构造上运行的恶意软件篡改。 此问题通过使用已签名的模板磁盘（签名的模板磁盘，其磁盘签名由受信任的管理员或 VM 所有者创建）解决。 创建受防护的 VM 时，模板磁盘的签名将与指定的防护数据文件中包含的签名进行比较。 如果任何防护数据文件的签名与模板磁盘的签名相匹配，则部署过程将继续。 如果找不到匹配项，则将中止部署过程，确保不会因模板磁盘不受信任而泄露 VM 机密。

使用已签名的模板磁盘创建受防护的 Vm 时，可以使用以下两个选项：

1. 使用虚拟化提供商提供的现有的已签名模板磁盘。 在这种情况下，虚拟化提供程序将保留已签名的模板磁盘。
2. 将已签名的模板磁盘上传到虚拟化结构。 VM 所有者负责维护签署的模板磁盘。 


