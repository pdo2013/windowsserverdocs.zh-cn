---
title: DNS 服务器疑难解答
description: 本文介绍如何从服务器端对 DNS 问题进行故障排除。
manager: willchen
ms.prod: ''
ms.technology: networking-dns
ms.topic: article
ms.author: delhan
ms.date: 8/8/2019
author: Deland-Han
ms.openlocfilehash: b0547436cfa0f07ba9cbc4e3dd1825f8d33bc093
ms.sourcegitcommit: 0e3c2473a54f915d35687d30d1b4b1ac2bae4068
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/09/2019
ms.locfileid: "68917764"
---
# <a name="troubleshooting-dns-servers"></a>DNS 服务器疑难解答

本文介绍如何解决 DNS 服务器上的问题。

## <a name="check-ip-configuration"></a>检查 IP 配置

1. 在`ipconfig /all`命令提示符下运行, 验证 IP 地址、子网掩码和默认网关。

2. 检查 DNS 服务器是否对正在查找的名称具有权威。 如果是这样, 请参阅[检查权威数据的问题](#checking-for-problems-with-authoritative-data)。

3. 运行下面的命令：

   ```cmd
   nslookup <name> <IP address of the DNS server>
   ```
   例如： 
   ```cmd
   nslookup app1 10.0.0.1
   ```
   如果出现故障或超时响应, 请参阅[检查递归问题](#checking-for-recursion-problems)。

4. 刷新解析程序缓存。 为此, 请在管理命令提示符窗口中运行以下命令:

   ```cmd
   dnscmd /clearcache
   ```
   或者, 在管理 PowerShell 窗口中运行以下 cmdlet:
   ```powershell
   Clear-DnsServerCache
   ```

5. 重复步骤3。 

## <a name="check-dns-server-problems"></a>检查 DNS 服务器问题

### <a name="event-log"></a>事件日志

检查以下日志以查看是否存在任何记录的错误:

- 应用程序

- 系统

- DNS 服务器

### <a name="test-by-using-nslookup-query"></a>使用 nslookup 查询进行测试

运行以下命令并检查是否可以从客户端计算机访问 DNS 服务器。

```cmd
nslookup <client name> <server IP address>
```

- 如果解析程序返回客户端的 IP 地址, 则服务器不会出现任何问题。

- 如果解析程序返回 "服务器故障" 或 "拒绝查询" 响应, 则该区域可能已暂停, 或者服务器可能已重载。 可以通过在 DNS 控制台中检查区域属性的 "常规" 选项卡来了解是否暂停了该功能。

如果解析程序返回 "请求服务器超时" 或 "无服务器响应" 响应, 则 DNS 服务可能未运行。 尝试重新启动 DNS 服务器服务, 方法是在服务器上的命令提示符下输入以下命令:

```cmd
net start DNS
```

如果在服务运行时出现问题, 则服务器可能不会侦听在 nslookup 查询中使用的 IP 地址。 在 DNS 控制台的 "服务器属性" 页的 "**接口**" 选项卡上, 管理员可以将 dns 服务器限制为只侦听选定的地址。 如果已将 DNS 服务器配置为将服务限制为其配置的 IP 地址的特定列表, 则用于联系 DNS 服务器的 IP 地址可能不在列表中。 可以尝试在列表中使用其他 IP 地址, 或将 IP 地址添加到列表。

在极少数情况下, DNS 服务器可能具有高级安全或防火墙配置。 如果服务器位于另一个只能通过中间主机 (如数据包筛选路由器或代理服务器) 访问的网络上, 则 DNS 服务器可能会使用非标准端口来侦听和接收客户端请求。 默认情况下, nslookup 将查询发送到 UDP 端口53上的 DNS 服务器。 因此, 如果 DNS 服务器使用任何其他端口, 则 nslookup 查询会失败。 如果认为这可能是个问题, 请检查是否有意使用了中间筛选器来阻止众所周知的 DNS 端口上的流量。 如果不是, 请尝试修改防火墙上的数据包筛选器或端口规则, 以允许 UDP/TCP 端口53上的流量。

## <a name="checking-for-problems-with-authoritative-data"></a>检查权威数据的问题

检查返回错误响应的服务器是否是该区域的主服务器 (区域的标准主服务器或使用 Active Directory 集成来加载区域的服务器) 或承载区域辅助副本的服务器。 

### <a name="if-the-server-is-a-primary-server"></a>如果服务器是主服务器

此问题可能是用户在区域中输入数据时出现用户错误引起的。 或者, 这可能是由影响 Active Directory 复制或动态更新的问题导致的。

### <a name="if-the-server-is-hosting-a-secondary-copy-of-the-zone"></a>如果服务器托管区域的辅助副本

1. 检查主服务器 (此服务器从中提取区域传输的服务器) 上的区域。

   > [!NOTE]
   >可以通过在 DNS 控制台中检查辅助区域的属性来确定哪个服务器是主服务器。

   如果主服务器上的名称不正确, 请执行步骤4。

2. 如果主服务器上的名称正确, 请检查主服务器上的序列号是否小于或等于辅助服务器上的序列号。 如果是这样, 请修改主服务器或辅助服务器, 使主服务器上的序列号大于辅助服务器上的序列号。 
  
3. 在辅助服务器上, 强制从 DNS 控制台内或通过运行以下命令进行区域传输:
  
   ```cmd
   dnscmd /zonerefresh <zone name>
   ```
  
   例如, 如果区域为 corp.contoso.com, 请输入: `dnscmd /zonerefresh corp.contoso.com`。
  
4. 再次检查辅助服务器, 以查看是否已正确传输区域。 否则, 你可能会遇到区域传输问题。 有关详细信息, 请参阅[区域传输问题](#zone-transfer-problems)。

5. 如果已正确传输区域, 请检查数据是否正确。 如果不是, 则数据在主要区域中不正确。 此问题可能是用户在区域中输入数据时出现用户错误引起的。 或者, 这可能是由影响 Active Directory 复制或动态更新的问题导致的。

## <a name="checking-for-recursion-problems"></a>检查递归问题

若要成功使用递归, 在递归查询路径中使用的所有 DNS 服务器都必须能够响应和转发正确的数据。 如果无法执行此操作, 则递归查询可能会由于以下原因而失败:

- 查询会在完成之前超时。

- 在查询过程中使用的服务器未能响应。

- 在查询期间使用的服务器提供了不正确的数据。

在原始查询中使用的服务器上开始进行故障排除。 检查 DNS 控制台的服务器属性中的 "**转发器**" 选项卡, 检查此服务器是否将查询转发到另一个服务器。 如果选中了 "**启用转发器**" 复选框, 并且列出了一台或多台服务器, 则此服务器将转发查询。

如果此服务器将查询转发到另一台服务器, 请检查是否存在影响此服务器将查询转发到的服务器的问题。 若要检查问题, 请参阅[检查 DNS 服务器问题](#check-dns-server-problems)。 当该部分指示你在客户端上执行任务时, 请在服务器上执行该任务。

如果服务器运行正常且可转发查询, 请重复此步骤, 并检查此服务器将查询转发到的服务器。

如果此服务器不将查询转发到另一台服务器, 请测试此服务器是否可以查询根服务器。 要执行此操作，请输入命令：

```cmd
nslookup
server <IP address of server being examined>
set q=NS
 ```

- 如果解析程序返回根服务器的 IP 地址, 则可能是根服务器与要尝试解析的名称或 IP 地址之间存在断开的委派。 按照[测试中断的委派](#test-a-broken-delegation)过程来确定有中断的委派。

- 如果解析程序返回 "请求服务器超时" 响应, 请检查根提示是否指向正常运行的根服务器。 为此, 请使用[查看当前根提示](#to-view-the-current-root-hints)过程。 如果根提示指向 "运行根服务器", 则可能存在网络问题, 或服务器可能使用阻止解析程序查询服务器的高级防火墙配置, 如 "[检查 DNS 服务器问题](#check-dns-server-problems)" 一节中所述。 还可能是递归超时默认值太短。

### <a name="test-a-broken-delegation"></a>测试中断的委派

通过查询有效的根服务器, 开始以下过程中的测试。 该测试将引导你完成将所有 DNS 服务器从根向下查询到你要进行损坏委派的服务器的过程。

1. 在要测试的服务器上的命令提示符下, 输入以下内容:

   ```cmd
   nslookup
   server <server IP address>
   set norecursion
   set querytype= <resource record type>
   <FQDN>
   ```
   > [!NOTE]
   >资源记录类型是在原始查询中查询的资源记录的类型, FQDN 是要查询的 FQDN (以句点结尾)。
 
2. 如果响应中包含委派服务器的 "NS" 和 "A" 资源记录的列表, 请对每个服务器重复步骤 1, 并使用 "A" 资源记录中的 IP 地址作为服务器 IP 地址。

   - 如果响应中不包含 "NS" 资源记录, 则你的委派已断开。
   
   - 如果响应包含 "NS" 资源记录, 但没有 "A" 资源记录, 请输入 "**设置递归**", 并分别查询 "NS" 记录中列出的服务器的 "A" 资源记录。 如果在区域的每个 NS 资源记录中都找不到至少一个 "A" 资源记录的有效 IP 地址, 则表示有一个中断的委派。

3. 如果你确定有一个中断的委派, 请通过在父区域中添加或更新 "A" 资源记录来修复此问题, 方法是使用适用于委派区域的正确 DNS 服务器的有效 IP 地址。

### <a name="to-view-the-current-root-hints"></a>查看当前的根提示

1. 启动 DNS 控制台。

2. 添加或连接到递归查询失败的 DNS 服务器。

3. 右键单击该服务器, 然后选择 "**属性**"。

4. 单击 "根提示"。

检查与根服务器的基本连接。

- 如果根提示看上去配置正确, 请验证在失败名称解析中使用的 DNS 服务器是否可以通过 IP 地址对根服务器进行 ping 操作。

- 如果根服务器不响应 IP 地址的 ping 操作, 则根服务器的 IP 地址可能已更改。 不过, 这种情况并不常见, 那就是看不到根服务器的重新配置。

## <a name="zone-transfer-problems"></a>区域传输问题

运行以下检查:

- 检查主 DNS 服务器和辅助 DNS 服务器的事件查看器。

- 请检查主服务器, 以查看其是否拒绝发送传输以获得安全。 

- 在 DNS 控制台中检查区域属性的 "**区域传送**" 选项卡。 如果服务器将区域传输限制为服务器列表 (如在区域属性的 "**名称服务器**" 选项卡上列出的服务器), 请确保辅助服务器在该列表中。 请确保将服务器配置为发送区域传输。

- 按照 "[检查 DNS 服务器问题](#check-dns-server-problems)" 一节中的步骤, 检查主服务器中的问题。 当系统提示你在客户端上执行任务时, 请改为在辅助服务器上执行该任务。

- 检查辅助服务器是否正在运行另一个 DNS 服务器实现, 如 BIND。 如果是, 则问题可能是以下原因之一:

  - Windows 主服务器可以配置为发送快速区域传送, 但第三方辅助服务器可能不支持快速区域传输。 如果是这种情况, 请通过在服务器属性的 "**高级**" 选项卡上选中 "**启用 Bind 辅助**角色" 复选框, 禁用主服务器上的跨域传输。

  - 如果 Windows server 上的正向查找区域包含辅助服务器不支持的记录类型 (例如, SRV 记录), 则在拉取区域时, 辅助服务器可能会出现问题。

检查主服务器是否正在运行另一个 DNS 服务器实现, 如 BIND。 如果是这样, 则可能是主服务器上的区域包含 Windows 无法识别的不兼容的资源记录。
 
如果主服务器或辅助服务器正在运行另一个 DNS 服务器实现, 请检查这两台服务器以确保它们支持相同的功能。 可以在服务器的 "属性" 页的 "**高级**" 选项卡上的 DNS 控制台中检查 Windows server。 除了 "启用 Bind 辅助副本" 框外, 此页还包括 "**名称检查**" 下拉列表。 这使你可以为 DNS 名称中的字符选择强制实施严格的 RFC 符合性。

