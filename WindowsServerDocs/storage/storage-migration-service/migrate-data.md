---
title: 使用存储迁移服务迁移文件服务器
description: 搜索引擎结果主题的简短说明
author: jasongerend
ms.author: jgerend
manager: elizapo
ms.date: 02/13/2019
ms.topic: article
ms.prod: windows-server
ms.technology: storage
ms.openlocfilehash: 80407630c4bcfe7e1f27cb68289967264ac74442
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 09/27/2019
ms.locfileid: "71393956"
---
# <a name="use-storage-migration-service-to-migrate-a-server"></a>使用存储迁移服务迁移服务器

本主题讨论如何使用[存储迁移服务](overview.md)和 Windows 管理中心将服务器（包括其文件和配置）迁移到另一台服务器。 一旦安装了服务并打开了任何必需的防火墙端口，迁移就需要执行三个步骤：清点服务器、传输数据和剪切到新服务器。

## <a name="step-0-install-storage-migration-service-and-check-firewall-ports"></a>步骤 0：安装存储迁移服务并检查防火墙端口

在开始之前，请安装存储迁移服务，并确保所需的防火墙端口已打开。

1. 检查[存储迁移服务要求](overview.md#requirements)，并在你的电脑或管理服务器上安装[Windows 管理中心](../../manage/windows-admin-center/understand/windows-admin-center.md)（如果尚未安装）。 如果迁移已加入域的源计算机，则必须在与源计算机连接的域或林所在的服务器上安装和运行存储迁移服务。
2. 在 Windows 管理中心，连接到运行 Windows Server 2019 的 orchestrator 服务器。 <br>这是你将在其上安装存储迁移服务并用于管理迁移的服务器。 如果只迁移一个服务器，则可以使用目标服务器，只要该服务器运行的是 Windows Server 2019。 建议为任何多服务器迁移使用单独的业务流程服务器。
1. 中转到**服务器管理器**（在 Windows 管理中心中） >**存储迁移服务**，并选择 "**安装**" 以安装存储迁移服务及其必需组件（如图1所示）。
    ![存储迁移服务页的屏幕截图，其中显示了](media/migrate/install.png) "安装" 按钮**图1：安装存储迁移服务**
1. 在运行 Windows Server 2019 的所有目标服务器上安装存储迁移服务代理。 这会在目标服务器上安装时将传输速度加倍。 <br>为此，请在 Windows 管理中心中连接到目标服务器，然后前往**服务器管理器**（在 Windows 管理中心中） >**角色和功能**"，选择"**存储迁移服务代理**"，然后选择"**安装**"。
1. 在所有源服务器上以及运行 Windows Server 2012 R2 或 Windows Server 2016 的任何目标服务器上，在 Windows 管理中心中连接到每台服务器，然后中转到**服务器管理器**（在 Windows 管理中心中） >**防火墙** >  **传入规则**，然后检查是否启用了以下规则：
    - 文件和打印机共享 (SMB-In)
    - Netlogon 服务（NP-IN）
    - Windows Management Instrumentation （DCOM-IN）
    - Windows Management Instrumentation (WMI-In)

   如果使用的是第三方防火墙，则要打开的入站端口范围为 TCP/445 （SMB）、TCP/135 （RPC/DCOM 终结点映射器）以及 TCP 1025-65535 （RPC/DCOM 临时端口）。 存储迁移服务端口为 TCP/28940 （Orchestrator）和 TCP/28941 （代理）。

1. 如果使用协调器服务器来管理迁移，并且想要下载事件或传输的数据的日志，请检查是否也在该服务器上启用了 "文件和打印机共享（SMB）" 防火墙规则。

## <a name="step-1-create-a-job-and-inventory-your-servers-to-figure-out-what-to-migrate"></a>第 1 步：创建作业并清点服务器以找出要迁移的内容

在此步骤中，你将指定要迁移的服务器，并对其进行扫描以收集有关其文件和配置的信息。

1. 选择 "**新建作业**"，为作业命名，然后选择是否迁移使用 Samba 的 Windows 服务器和群集或 Linux 服务器。 然后选择 **"确定"** 。
2. 在 "**输入凭据**" 页上，键入在要从中进行迁移的服务器上工作的管理员凭据，然后选择 "**下一步**"。 <br>如果要从 Linux 服务器进行迁移，请改为在**Samba 凭据**和**Linux 凭据**页面上输入凭据，包括 SSH 密码或私钥。 

3. 选择 "**添加设备**"，键入源服务器名称或群集文件服务器的名称，然后选择 **"确定"** 。 <br>对于要清点的任何其他服务器，请重复此步骤。

4. 选择 "**开始扫描**"。<br>在扫描完成后，页面将更新以显示。
    ![显示准备扫描](media/migrate/inventory.png) **的服务器的屏幕截图图2：清点服务器**
5. 选择每个服务器以查看已列出清单的共享、配置、网络适配器和卷。 <br><br>存储迁移服务不会传输我们知道可能会干扰 Windows 操作的文件或文件夹，因此在此版本中，你将看到位于 Windows 系统文件夹中的任何共享的警告。 在传输阶段需要跳过这些共享。 有关详细信息，请参阅[从传输中排除哪些文件和文件夹](faq.md#what-files-and-folders-are-excluded-from-transfers)。
6. 选择 "**下一步**" 继续传输数据。

## <a name="step-2-transfer-data-from-your-old-servers-to-the-destination-servers"></a>步骤 2：将数据从旧服务器传输到目标服务器

在此步骤中，你在指定将数据放置在目标服务器上的位置后传输数据。

1. 在 "**传输数据** > **输入凭据**" 页上，键入在要迁移到的目标服务器上工作的管理员凭据，然后选择 "**下一步**"。
2. 在 "**添加目标设备和映射**" 页上，将列出第一个源服务器。 键入要迁移到的服务器或群集文件服务器的名称，然后选择 "**扫描设备**"。 如果从已加入域的源计算机进行迁移，则目标服务器必须加入到同一个域。
3. 将源卷映射到目标卷，清除不想传输的任何共享的**包含**复选框（包括位于 Windows 系统文件夹中的任何管理共享），然后选择 "**下一步**"。
   ![显示源服务器及其卷和共享以及在目标](media/migrate/transfer.png) **图3上将其传输到的位置的屏幕截图：源服务器以及将其存储传输到的位置**
4. 为任何其他源服务器添加目标服务器和映射，然后选择 "**下一步**"。
5. 在 "**调整传输设置**" 页上，指定是否迁移源服务器上的本地用户和组，然后选择 "**下一步**"。 这使你可以重新创建目标服务器上的所有本地用户和组，以便将文件或共享权限设置为本地用户和组不会丢失。 下面是迁移本地用户和组时的选项：

    - 默认情况下会选择**具有相同名称的重命名帐户**，并迁移源服务器上的所有本地用户和组。 如果在源和目标上找到具有相同名称的本地用户或组，则它会在目标上重命名它们，除非它们是内置的（例如，管理员用户和管理员组）。
    - **使用相同名称的重复使用帐户**映射源和目标上名称相同的用户和组。
    - **请勿传输 "用户和组**" 跳过迁移本地用户和组，这在为 DFS 复制（DFS 复制不支持本地组和用户）设定数据种子时是必需的。

   > [!NOTE]
   > 已迁移的用户帐户在目标上被禁用，并为其分配了一个包含127个字符的密码，该密码既是复杂的又是随机的，因此你必须启用它们并在你完成使用时分配新密码。 这有助于确保在源中使用忘记和弱密码的任何旧帐户不会继续成为目标的安全问题。 你可能还需要签出[本地管理员密码解决方案（LAPS）](https://www.microsoft.com/download/details.aspx?id=46899) ，以便管理本地管理员密码。

6. 选择 "**验证**"，然后选择 "**下一步**"。
7. 选择 "**开始传输**" 开始传输数据。<br>第一次传输时，会将目标中的任何现有文件移动到备份文件夹。 在后续传输中，默认情况下会刷新目标，而不先进行备份。 <br>另外，存储迁移服务非常智能地处理重叠共享-我们不会在同一作业中复制相同的文件夹两次。
8. 传输完成后，请查看目标服务器以确保所有内容都已正确传输。 如果要下载未传输的任何文件的日志，请选择 "**仅错误日志**"。

   > [!NOTE]
   > 如果要保留传输的审核线索或计划在一个作业中执行多个传输，请单击 "**传输日志**" 或其他日志保存选项以保存 CSV 副本。 每个后续传输将覆盖上一次运行的数据库信息。 

此时，你有三个选项：

- **请继续执行下一步**操作，使目标服务器采用源服务器的标识。
- **请考虑在**不接管源服务器标识的情况下完成迁移。
- **再次传输**，仅复制自上次传输以来已更新的文件。

如果你的目标是将文件与 Azure 同步，则可以在传输文件之后或在切换到目标服务器之后，使用 Azure 文件同步设置目标服务器（请参阅[规划 Azure 文件同步部署](https://docs.microsoft.com/azure/storage/files/storage-sync-files-planning)）。

## <a name="step-3-cut-over-to-the-new-servers"></a>步骤 3:剪切到新服务器

在此步骤中，你将从源服务器剪切到目标服务器，并将 IP 地址和计算机名称移动到目标服务器。 完成此步骤后，应用和用户通过从中迁移的服务器的名称和地址访问新的服务器。

1. 如果离开了迁移作业，请在 Windows 管理中心中转到**服务器管理器** > **存储迁移服务**，然后选择要完成的作业。
2. 在 "切换**到新服务器** > " 的 "**输入凭据**" 页上，选择 "**下一步**" 以使用之前键入的凭据。

   如果目标是群集文件服务器，则可能需要提供具有从域中删除群集的权限的凭据，然后使用新名称将其重新添加。

3. 在 "**配置**切换" 页上，指定目标上的哪个网络适配器应接管源上每个适配器的设置。 这会在转换过程中将 IP 地址从源移动到目标，从而为源服务器提供新的 DHCP 或静态 IP 地址。 您可以选择跳过所有网络迁移或某些接口。 
4. 指定在转换后，要用于源服务器的 IP 地址将其地址移至目标。 你可以使用 DHCP 或静态地址。 如果使用静态地址，则新的子网必须与旧子网相同，否则转换将失败。
    ![显示源服务器及其 IP 地址和计算机名称的屏幕截图，以及在切换后将替换为](media/migrate/cutover.png) **图形4的内容：源服务器及其网络配置将如何移动到目标**
5. 指定在目标服务器接管源服务器的名称后如何重命名该源服务器。 你可以自行使用随机生成的名称或类型。 然后选择 "**下一步**"。
6. 在 "调整切换**设置**" 页上选择 "**下一步**"。
7. 在 "**验证源和目标设备**" 页上选择 "**验证**"，然后选择 "**下一步**"。
8. 如果已准备好执行转换，请选择 "**开始**转换"。 <br>用户和应用程序在移动地址和名称时可能会遇到中断，并且服务器每次都重新启动几次，但不受迁移的影响。 切换所花费的时间取决于服务器重新启动的速度，以及 Active Directory 和 DNS 复制时间。

## <a name="see-also"></a>请参阅

- [存储迁移服务概述](overview.md)
- [存储迁移服务常见问题（FAQ）](faq.md)
- [规划 Azure 文件同步部署](https://docs.microsoft.com/azure/storage/files/storage-sync-files-planning)
