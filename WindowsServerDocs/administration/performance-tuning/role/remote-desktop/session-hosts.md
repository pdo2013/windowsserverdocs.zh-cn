---
title: 性能优化远程桌面会话主机
description: 远程桌面会话主机的性能优化指南
ms.prod: windows-server
ms.technology: performance-tuning-guide
ms.topic: article
ms.author: HammadBu; VladmiS
author: phstee
ms.date: 10/16/2017
ms.openlocfilehash: c50c0c981362bd96ed3bf1c603cde6bfeec289f4
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 09/27/2019
ms.locfileid: "71385017"
---
# <a name="performance-tuning-remote-desktop-session-hosts"></a>性能优化远程桌面会话主机


本主题讨论如何选择远程桌面会话主机（RD 会话主机）硬件、调整主机和优化应用程序。

**本主题内容：**

-   [选择适当的硬件来提高性能](#selecting-the-proper-hardware-for-performance)

-   [优化远程桌面会话主机的应用程序](#tuning-applications-for-remote-desktop-session-host)

-   [远程桌面会话主机优化参数](#remote-desktop-session-host-tuning-parameters)

## <a name="selecting-the-proper-hardware-for-performance"></a>根据性能选择适当的硬件


对于 RD 会话主机服务器部署，可通过应用程序集来控制硬件的选择，以及用户如何使用它们。 影响用户数量及其体验的关键因素包括 CPU、内存、磁盘和图形。 本部分包含特定于 RD 会话主机服务器的其他准则，并且主要与 RD 会话主机服务器的多用户环境有关。

### <a name="cpu-configuration"></a>CPU 配置

CPU 配置在概念上是通过将所需的 CPU 与系统预期支持的会话数相乘来支持会话，同时保持缓冲区域来处理临时峰值。 多个逻辑处理器有助于减少异常的 CPU 拥塞情况，这通常是由类似数量的逻辑处理器所包含的几个 overactive 线程所致。

因此，系统上的逻辑处理器越多，必须内置于 CPU 使用量估算的缓冲范围越小，这将导致每个 CPU 的活动负载百分比更大。 需要注意的一个重要因素是，将 Cpu 数量加倍不会使 CPU 容量加倍。

### <a name="memory-configuration"></a>内存配置

内存配置依赖于用户使用的应用程序;但是，可以使用以下公式估计所需的内存量：TotalMem = OSMem + SessionMem \* NS

OSMem 是操作系统运行所需的内存量（例如系统二进制文件、数据结构等），SessionMem 是一个会话中运行的内存进程数，NS 是活动会话的目标数。 会话所需的内存量主要由会话内运行的应用程序和系统进程的专用内存引用集决定。 共享代码或数据页没有任何影响，因为系统上只有一个副本。

一个有趣的观察（假设正在备份页面文件的磁盘系统不会更改）是系统计划支持的并发活动会话的数量越大，每个会话的内存分配就越大。 如果未增加每个会话分配的内存量，则活动会话生成的页面错误数将随着会话数的增加而增加。 这些故障最终会使 i/o 子系统出现严重错误。 通过增加每个会话分配的内存量，导致页错误的概率会下降，这有助于降低页面错误的总体速率。

### <a name="disk-configuration"></a>磁盘配置

在配置 RD 会话主机服务器时，存储是最受忽视的方面之一，并且它可能是在现场部署的系统中最常见的限制。

典型 RD 会话主机服务器上生成的磁盘活动会影响以下方面：

-   系统文件和应用程序二进制文件

-   页面文件

-   用户配置文件和用户数据

理想情况下，这些领域应由不同的存储设备进行备份。 使用条带化 RAID 配置或其他类型的高性能存储进一步提高了性能。 强烈建议将存储适配器与支持电池的写入缓存配合使用。 具有磁盘写入缓存的控制器为同步写入操作提供了改进的支持。 由于所有用户都有一个单独的 hive，因此在 RD 会话主机服务器上的同步写入操作非常常见。 注册表配置单元通过使用同步写入操作定期保存到磁盘。 若要启用这些优化，请在 "磁盘管理" 控制台中，打开目标磁盘的 "**属性**" 对话框，然后在 "**策略**" 选项卡上，选择 "在**磁盘上启用写入缓存**并关闭**Windows 写入缓存缓冲区"** 在设备复选框上刷新。

### <a name="network-configuration"></a>网络配置

RD 会话主机服务器的网络使用情况包括两个主要类别：

-   RD 会话主机连接流量的使用量几乎由会话内运行的应用程序和重定向的设备 i/o 流量所表现的绘制模式决定。

    例如，处理文本处理和数据输入的应用程序消耗大约10到100千比特/秒的带宽，而丰富的图形和视频播放会导致带宽使用量大幅增加。

-   后端连接，如漫游配置文件、对文件共享、数据库服务器、电子邮件服务器和 HTTP 服务器的应用程序访问。

    网络流量的卷和配置文件特定于每个部署。

## <a name="tuning-applications-for-remote-desktop-session-host"></a>优化远程桌面会话主机的应用程序


RD 会话主机服务器上的大多数 CPU 使用率由应用驱动。 桌面应用程序的响应速度通常是为了最大程度地降低应用程序响应用户请求所用的时间。 但是，在服务器环境中，最大程度地减少完成操作所需的 CPU 使用总量，以避免对其他会话造成不利影响。

配置要在 RD 会话主机服务器上使用的应用时，请考虑以下建议：

-   最小化后台空闲循环处理

    典型的示例是禁用背景语法和拼写检查、用于搜索的数据索引，以及后台保存。

-   最大程度地减少应用执行状态检查或更新的频率。

    禁用此类行为或增加轮询迭代和计时器触发之间的时间间隔极大地提高了 CPU 使用率，因为此类活动的效果快速为多个活动会话放大。 典型示例包括连接状态图标和状态栏信息更新。

-   降低应用程序的同步频率，从而最大程度地减少资源争用。

    此类资源的示例包括注册表项和配置文件。 应用程序组件和功能的示例包括状态指示器（如 shell 通知）、后台索引或更改监视以及脱机同步。

-   禁用注册为以用户登录或会话启动开始的不必要的进程。

    当创建新的用户会话（这通常是一个占用大量 CPU 的过程）时，这些过程可能会显著影响 CPU 使用率的成本，而在早上的情况下，这可能非常昂贵。 使用 Msconfig.exe 或 appcmd.exe 获取在用户登录时启动的进程的列表。 有关更多详细信息，可以使用[autoruns.exe For Windows](https://technet.microsoft.com/sysinternals/bb963902.aspx)。

对于内存消耗，应考虑以下事项：

-   验证应用加载的 Dll 是否未重定位。

    -   可以通过选择 "进程 DLL 视图" 来验证重定位的 Dll，如下图所示，使用[进程资源管理器](https://technet.microsoft.com/sysinternals/bb896653.aspx)。

    -   在这里，我们可以看到，由于 x 已占用了其默认基址，而未启用 ASLR，因此已将其重定位。

        ![重新定位的 dll](../../media/perftune-guide-relocated-dlls.png)

        如果重定位 Dll，则不可能跨会话共享代码，这会大幅增加会话的占用量。 这是 RD 会话主机服务器上最常见的与内存相关的性能问题之一。

-   对于公共语言运行时（CLR）应用程序，请使用本机映像生成器（Ngen.exe）来增加页面共享并降低 CPU 开销。

    如果可能，请将类似的技术应用到其他类似的执行引擎。

## <a name="remote-desktop-session-host-tuning-parameters"></a>远程桌面会话主机优化参数


### <a name="page-file"></a>页面文件

页文件大小不足会导致应用程序或系统组件中的内存分配失败。 您可以使用内存到提交的字节性能计数器来监视系统上已提交的虚拟内存量。

### <a name="antivirus"></a>防病毒

在 RD 会话主机服务器上安装防病毒软件会极大地影响系统的整体性能，尤其是 CPU 使用率。 我们强烈建议你从活动监视列表中排除包含临时文件的所有文件夹，尤其是那些服务和其他系统组件生成的文件夹。

### <a name="task-scheduler"></a>任务计划程序

任务计划程序允许你检查计划用于不同事件的任务的列表。 对于 RD 会话主机服务器，特别关注配置为在空闲状态、用户登录或会话连接和断开连接时运行的任务。 由于部署的具体情况，其中很多任务都可能是不必要的。

### <a name="desktop-notification-icons"></a>桌面通知图标

桌面上的通知图标可以具有相当昂贵的刷新机制。 你应禁用任何通知，方法是从启动列表中删除注册它们的组件，或更改应用程序和系统组件上的配置以禁用这些通知。 你可以使用**自定义通知图标**来检查服务器上可用的通知的列表。

### <a name="remotefx-data-compression"></a>RemoteFX 数据压缩

Microsoft RemoteFX 可以使用组策略在 "**计算机配置" &gt; 管理模板 @no__t Windows 组件 &gt; 远程桌面服务 @no__t 远程桌面会话主机会话环境 &gt; 配置 RemoteFX 数据的压缩**。 可能有三个值：

-   **经过优化，可使用更少内存**每个会话使用的内存量最少，但压缩率最低，因此带宽消耗最大。

-   **平衡内存和网络带宽**减少带宽消耗，同时增加内存消耗（大约每个会话 200 KB）。

-   **经过优化，可使用更少的网络带宽**进一步降低网络带宽使用率，成本大约为每个会话 2 MB。 如果要使用此设置，应在将服务器放入生产环境之前，使用此设置来评估会话的最大数量并进行测试。

你还可以选择不使用 RemoteFX 压缩算法。 选择不使用 RemoteFX 压缩算法将会使用更多网络带宽，并且仅当使用的硬件设备设计用于优化网络流量时，才建议使用该算法。 即使您选择不使用 RemoteFX 压缩算法，也会压缩某些图形数据。

### <a name="device-redirection"></a>设备重定向

可以通过使用组策略 "**计算机配置" &gt; 管理模板 &gt; Windows 组件 &gt; 远程桌面服务 @no__t 远程桌面会话主机重定向**或使用服务器管理器中的 "**会话集合**属性" 框。

通常，设备重定向会增加 RD 会话主机服务器连接所使用的网络带宽量，因为数据在客户端计算机上的设备与服务器会话中运行的进程之间进行交换。 增加的程度是指在服务器上运行的应用程序针对重定向的设备执行的操作频率的函数。

打印机重定向和即插即用设备重定向也会在登录时增加 CPU 使用率。 可以通过两种方式重定向打印机：

-   当服务器上必须安装打印机的驱动程序时，匹配基于打印机驱动程序的重定向。 Windows Server 的早期版本使用此方法。

-   Windows Server 2008 中引入了简单的打印打印机驱动程序重定向，适用于所有打印机的打印机驱动程序。

建议使用简单的 Print 方法，因为它会导致在连接时安装的 CPU 使用率较低。 匹配驱动程序方法导致 CPU 使用率增加，因为它需要后台处理程序服务加载不同的驱动程序。 对于带宽使用量，简单的打印会导致网络带宽使用略微增加，但并不太重要，无法抵消其他性能、可管理性和可靠性优势。

音频重定向导致网络流量稳定。 音频重定向还使用户能够运行通常具有较高 CPU 消耗的多媒体应用。

### <a name="client-experience-settings"></a>客户端体验设置

默认情况下，远程桌面连接（RDC）根据服务器和客户端计算机之间的网络连接的适用性自动选择正确的体验设置。 建议在**自动检测连接质量**时保留 RDC 配置。

对于高级用户，RDC 提供对影响远程桌面服务连接的网络带宽性能的一系列设置的控制。 你可以通过使用远程桌面连接中的 "**体验**" 选项卡或使用 RDP 文件中的设置来访问以下设置。

连接到任何计算机时，将应用以下设置：

-   **禁用墙纸**（禁用墙纸： i：0）不会在重定向连接上显示桌面墙纸。 如果桌面墙纸包含图像或其他内容，而该图像或其他内容的绘制成本非常大，则此设置可显著减少带宽使用。

-   **位图缓存**（Bitmapcachepersistenable： i：1）启用此设置后，它将创建在会话中呈现的位图的客户端缓存。 它提供对带宽使用的显著改进，并且应始终启用此功能（除非有其他安全注意事项）。

-   **拖动时显示窗口内容**（禁用完整窗口拖动： i：1）禁用此设置时，它会通过仅显示窗口框架而不是在拖动窗口时显示所有内容来减少带宽。

-   **菜单和窗口动画**（禁用菜单 anims： i：1并禁用光标设置： i：1）：禁用这些设置后，将通过禁用菜单上的动画（如褪色）和光标来减少带宽。

-   **字体平滑**（允许字体平滑： i：0）控制 ClearType 字体呈现支持。 连接到运行 Windows 8 或 Windows Server 2012 及更高版本的计算机时，启用或禁用此设置不会对带宽使用产生严重影响。 但是，对于运行 Windows 7 和 Windows 2008 R2 之前版本的计算机，启用此设置会显著影响网络带宽消耗。

以下设置仅适用于连接到运行 Windows 7 和更早版本的操作系统版本的计算机：

-   **桌面合成**仅对运行 Windows 7 或 Windows Server 2008 R2 的计算机的远程会话支持此设置。

-   **视觉样式**（禁用主题： i：1）当禁用此设置时，它通过简化使用经典主题的主题绘图来减少带宽。

通过使用远程桌面连接中的 "**体验**" 选项卡，你可以选择连接速度来影响网络带宽性能。 下表列出了可用于配置连接速度的选项：

-   **自动检测连接质量**（连接类型： i：7）启用此设置时，远程桌面连接会自动选择将根据连接质量获得最佳用户体验的设置。 （连接到运行 Windows 8 或 Windows Server 2012 及更高版本的计算机时，建议使用此配置）。

-   **调制解调器（56 Kbps）** （连接类型： i：1）此设置启用持久位图缓存。

-   **低速宽带（256 Kbps-2 Mbps）** （连接类型： i：2）此设置启用持久位图缓存和视觉样式。

-   **移动电话/附属项（2Mbps-16 Mbps，具有高延迟）** （连接类型： i：3）此设置启用桌面组合、持久位图缓存、视觉样式和桌面背景。

-   **高速宽带（2 mbps – 10 mbps）** （连接类型： i：4）此设置允许桌面合成、在拖动时显示窗口内容、菜单和窗口动画、持久位图缓存、视觉样式和桌面背景。

-   **WAN （10 Mbps 或更高的高延迟）** （连接类型： i：5）此设置允许桌面合成、在拖动时显示窗口内容、菜单和窗口动画、持久位图缓存、视觉样式和桌面背景。

-   **LAN （10 Mbps 或更高版本）** （连接类型： i：6）此设置允许桌面合成、在拖动时显示窗口内容、菜单和窗口动画、持久位图缓存、主题和桌面背景。

### <a name="desktop-size"></a>桌面大小

可以通过使用远程桌面连接中的 "显示" 选项卡或使用 RDP 配置文件（desktopwidth： i：1152和 desktopheight： i：864）控制远程会话的桌面大小。 桌面大小越大，与该会话关联的内存和带宽消耗就越大。 当前最大桌面大小为 4096 x 2048。
