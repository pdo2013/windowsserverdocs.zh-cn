---
title: AD FS 故障排除-证书
description: 本文档介绍典型的证书问题。
author: billmath
ms.author: billmath
manager: mtillman
ms.date: 02/21/2017
ms.topic: article
ms.prod: windows-server
ms.technology: identity-adfs
ms.openlocfilehash: fdadbefc138562246c72f7707b303d966bff0989
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 09/27/2019
ms.locfileid: "71407197"
---
# <a name="ad-fs-troubleshooting---certificates"></a>AD FS 故障排除-证书
AD FS 需要以下证书才能正常工作。  如果未正确设置或配置任何这些设置，则可能会出现问题。  

## <a name="required-certificates"></a>必需的证书
AD FS 需要以下证书：



- **联合信任**–这要求链接到相互信任的 Internet 根证书颁发机构（CA）的证书同时出现在声明提供程序和信赖方联合服务器的受信任的根存储中。实现了交叉认证设计，其中每一方都将其根 CA 与其合作伙伴或在每一侧导入的自签名证书交换。
- **令牌签名**–每个联合身份验证服务计算机都需要令牌签名证书。  声明提供方令牌签名证书必须受信赖方联合服务器信任。 从 RP 联合服务器接收令牌的所有应用程序都必须信任信赖方令牌签名证书。
- **安全套接字层（SSL）** –联合身份验证服务的 SSL 证书必须在联合服务器代理计算机上的受信任存储区中，并且具有到受信任的证书颁发机构（CA）存储区的有效链。
- **证书吊销列表（CRL）** –对于已发布 crl 的任何证书，必须可访问所有需要访问证书的客户端和服务器的 CRL。

如果未正确配置上述任何配置，AD FS 将不起作用。

## <a name="common-things-to-check-with-certificates"></a>用于检查证书的常见问题
下面列出了可能出现的情况，并应在尝试解决证书问题时进行验证。

- 确保证书可信
    - SSL 证书必须受客户端信任
    - 需要信赖方信任令牌签名证书
- 检查信任链-证书链中的每个证书都需要有效。
- 验证证书的到期日期
- 检查证书吊销列表（CRL）辅助功能
    - 请确保已填充 CDP 字段
    - 手动浏览到 CDP
- 请确保证书未被吊销

## <a name="common-certificate-errors"></a>常见证书错误
下表列出了常见错误和可能的原因。

|Event|原因|分辨率
|-----|-----|-----|
|事件 249-在证书存储中找不到证书。 在证书滚动更新方案中，当联合身份验证服务使用此证书进行签名或解密时，这可能会导致失败。|此证书在本地证书存储区中不存在，或者服务帐户无权使用证书的私钥。|确保该证书安装在 AD FS 服务器上的 LocalMAchine\My 存储中。 确保 AD FS 的服务帐户具有对证书私钥的读取访问权限。|
|事件 315-尝试为声明提供方信任签名证书构建证书链期间出错。|证书已吊销。</br></br>无法验证证书链。</br></br>证书已过期或尚未生效。|确保证书有效且未被吊销。</br></br>确保 CRL 可访问。|
|事件 316-尝试为信赖方信任签名证书构建证书链期间出错。|证书已吊销。</br></br>无法验证证书链。</br></br>证书已过期或尚未生效。|确保证书有效且未被吊销。</br></br>确保 CRL 可访问。|
|事件 317-尝试为信赖方信任加密证书构建证书链期间出错。|证书已吊销。</br></br>无法验证证书链。</br></br>证书已过期或尚未生效。|确保证书有效且未被吊销。</br></br>确保 CRL 可访问。|
|事件 319-生成客户端证书的证书链时出错。|证书已吊销。</br></br>无法验证证书链。</br></br>证书已过期或尚未生效。|确保证书有效且未被吊销。</br></br>确保 CRL 可访问。|
|事件 360-向证书传输终结点发出了请求，但该请求不包括客户端证书。|颁发客户端证书的根 CA 不受信任。</br></br>客户端证书已过期。</br></br>客户端证书是自签名的，不受信任。|确保颁发客户端证书的根 CA 出现在受信任的根存储中。</br></br>确保客户端证书未过期。</br></br>如果客户端证书是自签名客户端证书，请确保已将其添加到受信任的证书列表中，或将自签名证书替换为受信任的证书。|
|事件 374-为声明提供方信任加密证书构建证书链时出错。|证书已吊销。</br></br>无法验证证书链。</br></br>证书已过期或尚未生效。|确保证书有效且未被吊销。</br></br>确保 CRL 可访问。|
|事件 381-尝试为配置证书构建证书链期间出错。|配置为在 AD FS 服务器上使用的证书之一已过期或已被吊销。|确保所有配置的证书未被吊销且未过期。|
|事件 385-AD FS 检测到 AD FS 配置数据库中的一个或多个证书需要手动更新。|配置为在 AD FS 服务器上使用的证书之一已过期或即将过期。|使用替换更新过期或即将过期的证书。 （如果你使用的是自签名证书，并且启用了自动证书滚动更新，则此错误可能会被忽略，因为它将自行解决。）|
|事件 387-AD FS 检测到联合身份验证服务中指定的一个或多个证书无法访问 AD FS Windows 服务所使用的服务帐户。|AD FS 服务帐户没有对一个或多个已配置证书的私钥的读取权限。|确保 AD FS 服务帐户对所有配置的证书的私钥具有 "读取" 权限。|
|事件 389-AD FS 检测到一个或多个信任需要手动更新其证书，因为它们已过期或即将过期。|某个已配置伙伴的证书已过期或即将过期。 这可以应用于声明提供方信任或信赖方信任。|如果已手动创建此信任，请手动更新证书配置。 如果使用了联合元数据创建信任，一旦伙伴更新证书，证书就会自动更新。|




## <a name="next-steps"></a>后续步骤

- [AD FS 疑难解答](ad-fs-tshoot-overview.md)
 